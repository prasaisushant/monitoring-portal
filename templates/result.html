<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Stats Results</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function fetchStats() {
            $.ajax({
                url: '/data',
                type: 'GET',
                success: function(data) {
                    if (data.error) {
                        $('#error').text('Error: ' + data.error);
                    } else {
                        var timestamps = [];
                        var cpuUsageData = [];
                        var memUsageData = [];
                        data.forEach(function(row) {
                            timestamps.push(new Date(row[6]).toLocaleTimeString());
                            cpuUsageData.push(parseFloat(row[2]));
                            memUsageData.push((parseFloat(row[4]) / parseFloat(row[3]) * 100).toFixed(2));
                        });

                        var ctx1 = document.getElementById('cpuChart').getContext('2d');
                        new Chart(ctx1, {
                            type: 'line',
                            data: {
                                labels: timestamps,
                                datasets: [{
                                    label: 'CPU Usage (%)',
                                    data: cpuUsageData,
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 2,
                                    fill: false
                                }]
                            },
                            options: {
                                scales: {
                                    x: {
                                        title: { display: true, text: 'Time' }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        title: { display: true, text: 'CPU Usage (%)' }
                                    }
                                }
                            }
                        });

                        var ctx2 = document.getElementById('memChart').getContext('2d');
                        new Chart(ctx2, {
                            type: 'line',
                            data: {
                                labels: timestamps,
                                datasets: [{
                                    label: 'Memory Usage (%)',
                                    data: memUsageData,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 2,
                                    fill: false
                                }]
                            },
                            options: {
                                scales: {
                                    x: {
                                        title: { display: true, text: 'Time' }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        title: { display: true, text: 'Memory Usage (%)' }
                                    }
                                }
                            }
                        });
                    }
                }
            });
        }

        $(document).ready(function() {
            fetchStats();  // Fetch initial stats
            var interval = parseInt(localStorage.getItem('updateInterval'), 10) || 5000;
            setInterval(fetchStats, interval);

            $('#intervalForm').on('submit', function(event) {
                event.preventDefault();
                var newInterval = $('#interval').val();
                if (newInterval && !isNaN(newInterval) && newInterval > 0) {
                    localStorage.setItem('updateInterval', newInterval * 1000);
                    clearInterval(window.fetchInterval);
                    window.fetchInterval = setInterval(fetchStats, newInterval * 1000);
                    $.post('/update_interval', { interval: newInterval }, function(response) {
                        console.log('Interval updated:', response);
                    });
                } else {
                    alert('Please enter a valid interval in seconds.');
                }
            });
        });
    </script>
</head>
<body>
    <h1>Server Stats</h1>
    <div id="error"></div>
    <form id="intervalForm">
        <label for="interval">Update Interval (seconds):</label><br>
        <input type="number" id="interval" name="interval" value="5" min="1" required><br><br>
        <input type="submit" value="Update Interval">
    </form>
    <canvas id="cpuChart" width="400" height="200"></canvas>
    <canvas id="memChart" width="400" height="200"></canvas>
    <br>
    <a href="{{ url_for('index') }}">Back</a>
</body>
</html>
